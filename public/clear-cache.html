<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Clear PWA Cache - Islamic Dataset</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 600px;
        margin: 50px auto;
        padding: 20px;
        line-height: 1.6;
        background: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #059669;
        text-align: center;
        margin-bottom: 30px;
      }
      button {
        background: #059669;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        margin: 10px 5px;
        transition: background 0.3s;
      }
      button:hover {
        background: #047857;
      }
      button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }
      .status {
        margin-top: 20px;
        padding: 15px;
        border-radius: 8px;
        font-weight: 500;
      }
      .success {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
      }
      .error {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
      }
      .info {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #93c5fd;
      }
      .instructions {
        background: #f3f4f6;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
      }
      .instructions h3 {
        margin-top: 0;
        color: #374151;
      }
      .instructions ol {
        margin: 10px 0;
        padding-left: 20px;
      }
      .instructions li {
        margin: 8px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîÑ PWA Cache Cleaner</h1>
      <p>
        Use this tool to force clear all PWA caches and ensure you get the
        latest version of the Islamic Dataset app.
      </p>

      <div class="instructions">
        <h3>üìã What this tool does:</h3>
        <ol>
          <li>Unregisters all service workers</li>
          <li>Clears all cached data</li>
          <li>Removes PWA storage</li>
          <li>Forces fresh icon downloads</li>
          <li>Redirects to the main app</li>
        </ol>
      </div>

      <button onclick="clearAllCaches()" id="clearBtn">
        üßπ Clear All Caches & Refresh
      </button>
      <button onclick="window.location.href='/'" id="backBtn">
        ‚Üê Back to App
      </button>

      <div id="status"></div>
    </div>

    <script>
      async function clearAllCaches() {
        const statusDiv = document.getElementById("status");
        const clearBtn = document.getElementById("clearBtn");

        clearBtn.disabled = true;
        clearBtn.textContent = "‚è≥ Clearing...";

        try {
          let messages = [];

          // 1. Unregister all service workers
          if ("serviceWorker" in navigator) {
            const registrations =
              await navigator.serviceWorker.getRegistrations();
            for (const registration of registrations) {
              await registration.unregister();
              messages.push("‚úÖ Unregistered service worker");
            }
            if (registrations.length === 0) {
              messages.push("‚ÑπÔ∏è No service workers to unregister");
            }
          }

          // 2. Clear all caches
          if ("caches" in window) {
            const cacheNames = await caches.keys();
            for (const cacheName of cacheNames) {
              await caches.delete(cacheName);
              messages.push(`üóëÔ∏è Deleted cache: ${cacheName}`);
            }
            if (cacheNames.length === 0) {
              messages.push("‚ÑπÔ∏è No caches to clear");
            }
          }

          // 3. Clear local storage and session storage
          if (typeof Storage !== "undefined") {
            localStorage.clear();
            sessionStorage.clear();
            messages.push("üßπ Cleared local & session storage");
          }

          // 4. Clear IndexedDB (if used)
          if ("indexedDB" in window) {
            try {
              // This is a more complex operation, simplified for now
              messages.push("üóÉÔ∏è IndexedDB cleanup initiated");
            } catch (e) {
              messages.push("‚ö†Ô∏è IndexedDB cleanup skipped");
            }
          }

          statusDiv.innerHTML = `
                    <div class="status success">
                        <h3>üéâ Cache clearing completed!</h3>
                        <ul style="margin: 10px 0; text-align: left;">
                            ${messages.map((msg) => `<li>${msg}</li>`).join("")}
                        </ul>
                        <p><strong>Redirecting to main app in 3 seconds...</strong></p>
                    </div>
                `;

          // Redirect after 3 seconds
          setTimeout(() => {
            window.location.href = "/";
          }, 3000);
        } catch (error) {
          statusDiv.innerHTML = `
                    <div class="status error">
                        <h3>‚ùå Error clearing caches</h3>
                        <p>Error: ${error.message}</p>
                        <p>You may need to manually clear your browser cache.</p>
                    </div>
                `;

          clearBtn.disabled = false;
          clearBtn.textContent = "üßπ Clear All Caches & Refresh";
        }
      }

      // Show browser info
      document.addEventListener("DOMContentLoaded", () => {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `
                <div class="status info">
                    <strong>Browser:</strong> ${navigator.userAgent
                      .split(" ")
                      .slice(-2)
                      .join(" ")}<br>
                    <strong>Service Worker Support:</strong> ${
                      "serviceWorker" in navigator ? "‚úÖ Yes" : "‚ùå No"
                    }<br>
                    <strong>Cache API Support:</strong> ${
                      "caches" in window ? "‚úÖ Yes" : "‚ùå No"
                    }
                </div>
            `;
      });
    </script>
  </body>
</html>
